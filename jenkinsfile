pipeline {
    agent any
    stages {
        stage('Récupération du code') {
            steps {
                // Télécharge le code depuis la branche main de votre dépôt
                checkout scm
            }
        }
        stage('Déploiement vers Moodle') {
            steps {
                echo 'Copie des fichiers en cours...'
                // Synchronise le code GitHub avec le répertoire Apache
                sh 'sudo rsync -av --delete --exclude="config.php" . /var/www/html/moodle/'
                
                echo 'Mise à jour des permissions...'
                sh 'sudo chown -R www-data:www-data /var/www/html/moodle/'
            }
        }
        stage('Nettoyage Cache') {
            steps {
                echo 'Purge des caches Moodle...'
                sh 'sudo -u www-data php /var/www/html/moodle/admin/cli/purge_caches.php'
            }
        }
    }
}
